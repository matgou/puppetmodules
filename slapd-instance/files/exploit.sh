#!/bin/bash
#@****************************************************************************
#@ Author : Mathieu GOULIN (mathieu.goulin@gadz.org)
#@ Organization : Gadz.org (www.gadz.org) 
#@ Licence : GNU/GPL
#@ 
#@ Description : 
#@               
#@ Prerequisites :
#@ Arguments : 
#@
#@****************************************************************************
#@ History :
#@  - Mathieu GOULIN - 2015/05/31 : Initialisation du script
#@****************************************************************************
 
# Static configuration
script=`basename "$0" | cut -f1 -d"."`
log_file=`dirname $0`/$script.log
 
# Usage function
function usage () {
    # TODO - Write the good stuff here...
    echo "$0 [start|stop|restart]"
}
# Help function
function help () {
    usage
    echo
    grep -e "^#@" $script.sh | sed "s/^#@//"
}
 
# Log function
write_log () {
    log_state=$1
    shift;
    log_txt=$*
    log_date=`date +'%Y/%m/%d %H:%M:%S'`
    case ${log_state} in
        BEG)    chrtra="[START]"      ;;
        CFG)    chrtra="[CONF ERR]"   ;;
        ERR)    chrtra="[ERROR]"      ;;
        END)    chrtra="[END]"        ;;
        INF)    chrtra="[INFO]"       ;;
        *)      chrtra="[ - ]"        ;;
    esac
    echo "$log_date $chrtra : ${log_txt}" | tee -a ${log_file} 2>&1
}

. `dirname $0`/../config/config.sh

# Parameters function
start () {
  write_log INF "Start ldap daemon : $ENV"
  /usr/sbin/slapd -h "$URI" -F $ROOT/config/slapd.d/ -g $GROUP -u $USER -n openldap$ENV
  exit $?
}

stop () {
  write_log INF "Stop ldap daemon : $ENV"
  kill `cat $ROOT/run/slapd.pid`
  exit 0
}

restart() {
  stop 
  start
}
 
# Parameters management
while [ $# -gt 0 ]
do
    case $1 in
        start) start; shift ;;
        stop) stop; shift ;;
        restart) restart; shift ;;
        *) usage ; exit 1 ;;
    esac
    shift
done
 
exit 0
